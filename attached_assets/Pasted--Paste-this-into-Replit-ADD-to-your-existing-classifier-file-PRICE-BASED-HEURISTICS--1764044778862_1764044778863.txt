✅ Paste this into Replit (ADD to your existing classifier file)
// --- PRICE-BASED HEURISTICS ----------------------------------------------

// Normal MTG commons/uncommons (Lightning Bolt, Sol Ring) do NOT drop below $2
// unless they are alternate-frame, promo, or showcase variants.
//
// This heuristic catches "suspiciously cheap" variants that the HTML does not label.
function isSuspiciouslyCheap(baseCardName, normalizedName, price) {
  const cheapThresholds = {
    "lightning bolt": 2.20,
    "sol ring": 2.20,
  };

  const key = baseCardName.toLowerCase().trim();
  const limit = cheapThresholds[key];

  if (!limit) return false;
  return price < limit;
}


// --- POSITION / SORTING HEURISTIC -----------------------------------------

// Card Kingdom almost always lists the STANDARD edition FIRST.
// Any edition appearing after the first matching normal edition is suspicious.
function isSuspiciousByOrdering(index, firstNormalIndex) {
  if (firstNormalIndex == null) return false;
  return index > firstNormalIndex;
}


// --- WRAPPER that enhances your existing classifyVariant() -----------------

function classifyVariantEnhanced(product, index, firstNormalIndex, baseCardName) {
  const { name, price } = product;
  const result = classifyVariant(name, baseCardName); // ← your existing classifier
  const normalized = normalizeName(name);

  // If classifier already says SPECIAL, keep it.
  if (result !== "normal") return result;

  // Heuristic 1: Suspiciously cheap relative to expected baseline
  if (isSuspiciouslyCheap(baseCardName, normalized, price)) {
    return "special";
  }

  // Heuristic 2: Appears *after* the first normal edition in the product grid
  if (isSuspiciousByOrdering(index, firstNormalIndex)) {
    return "special";
  }

  return "normal"; // default
}

module.exports = {
  classifyVariantEnhanced,
};

✅ How to integrate (exact steps for server.js)

Paste this EXACTLY into Replit next:

// STEP 1 — Track the first normal edition index
let firstNormalIndex = null;

// STEP 2 — Replace your variant classification inside the product loop:
const variant = classifyVariantEnhanced(
  { name, price },
  index,
  firstNormalIndex,
  cardName
);

// STEP 3 — Capture the first NORMAL edition
if (variant === "normal" && firstNormalIndex === null) {
  firstNormalIndex = index;
}

✅ What this fixes immediately
Lightning Bolt:

Standard edition → normally index 0 → marked normal

Cheap $1.99 variant → appears later → flagged by:

price heuristic

ordering heuristic
→ classified as SPECIAL
→ standard $2.29 wins

Sol Ring:

Standard edition at index 0–3 → normal

$1.99 variant → flagged special for the same reasons
→ correct result: $2.29

Eliminates the case where:

Both editions appear “normal”

Sorting picks the cheapest wrong one