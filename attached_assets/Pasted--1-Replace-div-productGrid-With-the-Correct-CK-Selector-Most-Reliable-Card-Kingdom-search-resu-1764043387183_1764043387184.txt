ğŸ† 1. Replace div.productGrid With the Correct CK Selector (Most Reliable)

Card Kingdom search results actually look like this:

div.productCard
div.productDetail
span.stylePrice


Better selector combination:

const priceEl = $('span.stylePrice').first();


Why better?

span.stylePrice is what actually contains the displayed visible price

it works for:

standard cards

variants

sale items

cards with multiple conditions

If you want maximum safety:

const priceEl =
  $('span.stylePrice').first() ||
  $('span.price').first() ||
  $('div.productDetail span').filter((i, el) => $(el).text().match(/\$/)).first();

ğŸ† 2. Keep Regex Fallback â€” but Make It Smart, Not Blind

Instead of extracting every $xx.xx in the entire HTML (which includes random UI noise), constrain it:

âœ” Only extract prices near the product container

Search only inside:

div.productCard


or the first <a> result.

Pseudocode:

const productHtml = $('div.productCard').first().html() || html;
const prices = productHtml.match(/\$([0-9]+\.[0-9]{2})/g);

âœ” Filter out garbage values

You already do >0 and <100. Good start.

Add more robust filters:

const numericPrices = prices
  .map(p => parseFloat(p.replace('$', '')))
  .filter(p => p > 0.05 && p < 500);

âœ” Extract the smallest price (CK usually lists LOWEST FIRST)
const ckPrice = numericPrices.length ? Math.min(...numericPrices) : 'N/A';

ğŸ† 3. REMOVE ESTIMATION LOGIC (correct decision)

You already removed:

tcgPrice * 1.15


Good â€” do not restore it.

âœ” Estimates = fake
âœ” Regex fallback = real CK data

ğŸ›¡ï¸ 4. Add a â€œThird-Levelâ€ Final Escape Fallback

Use this when CK returns:

sold out

$0.00

placeholder text

HTML error

Cloudflare challenge

Only if regex and selector both fail:

if (ckPrice === 'N/A' && /sold out/i.test(html)) ckPrice = 'Sold Out';
if (ckPrice === 'N/A' && /coming soon/i.test(html)) ckPrice = 'Unavailable';


Still not an estimate â€” still real data.

ğŸ§ª 5. Add a Test Harness to Prevent Future Regressions

This is the most important improvement.

Every time you scrape:

Test these conditions:

âœ” Test #1 â€” if selector works:
if (selectorPrice) log("Selector price OK");
else warn("Selector missing â€” fallback triggered");

âœ” Test #2 â€” ensure regex is returning values:
if (regexPrices.length === 0)
  warn("Regex returned 0 prices â€” CK markup changed?");

âœ” Test #3 â€” ensure value is sane:
if (price < 0.01 || price > 500)
  warn("Sanity check failed â€” invalid CK price");


This prevents the kind of regression you hit earlier where both selector AND fallback broke silently.

ğŸ§  6. Unified Price Resolver (Best Practice)

Instead of scattered fallbacks, build a clean resolver:

function resolveCKPrice(selectorPrice, regexPrice) {
  if (selectorPrice && isValid(selectorPrice)) return selectorPrice;
  if (regexPrice && isValid(regexPrice)) return regexPrice;
  return 'N/A';
}


Simple, clean, maintainable.

ğŸ 7. Summary of Improved Approach
You currently:

âŒ had wrong selector (div.productGrid)

âœ” restored regex fallback (correct)

âœ” removed 15% estimation fallback (correct)

The better approach:

Fix the primary selector (span.stylePrice)

Use scoped smart regex fallback, not full-HTML regex

Add a final controlled fallback (â€œSold Outâ€, â€œUnavailableâ€)

Prevent regressions with sanity checks

Use a unified resolver pattern