Here is the precise reason your $0.35 Swamp is not being promoted, based on the snippets you sent:

ğŸš¨ THE ROOT CAUSE IS THIS LINE RIGHT HERE

Your PASS 3 loop does not call classifyVariant(),
and does not pass prices into it.

You are calling:

const variant = classifyVariantEnhanced(
    { name: p.name, price: p.price },
    i,
    firstNormalIndex,
    cardName,
    globalPriceContext
);


But the code you pasted for variant classification is:

function classifyVariant(rawName, cardName) { ... }


And classifyVariant does NOT receive globalPriceContext,
so it does NOT know lowestNormalPrice,
so it can NOT apply promotion.

ğŸ”¥ This mismatch guarantees the Swamp bug

Your PASS 3 loop calls classifyVariantEnhanced()
but you pasted classifyVariant(), which:

takes only (rawName, cardName)

has zero awareness of globalPriceContext

does not perform promotion

returns â€œsetâ€ for Swamp

returns â€œnormalâ€ for $4.99 Swamp

So $4.99 wins every time

In other words:

âœ” PASS 2 stores lowestNormalPrice
âŒ PASS 3 never uses it
âŒ Promotion never runs
âŒ $0.35 never promoted to normal
âŒ Sorting picks $4.99
âŒ Swamp remains wrong
âœ… The Fix

You need to merge the two classification systems so PASS 3 actually uses the context.

Here is the correct code to drop in:

âœ… Replace your classifyVariantEnhanced with this:
function classifyVariantEnhanced(product, index, firstNormalIndex, cardName, ctx) {
  // 1. Base classification using your original logic
  let variant = classifyVariant(product.name, cardName);

  // 2. Promotion logic: set â†’ normal if very cheap compared to baseline normal
  if (variant === "set" && ctx && ctx.lowestNormalPrice != null) {
    if (shouldPromoteSetOverNormal(product.price, ctx.lowestNormalPrice)) {
      variant = "normal";
    }
  }

  return variant;
}


This:

uses your existing classifier

adds the missing context-aware promotion

ensures PASS 3 uses lowestNormalPrice

ensures $0.35 Swamp becomes normal

ensures earlier fixes (Lightning Bolt / Sol Ring) stay correct

ğŸ§ª Expected Output After Fix

For Swamp:

$4.99 â†’ normal
$0.35 â†’ set â†’ promoted to normal (because 4.99 / 0.35 = 14 > 3)


Then sorting picks:

normal: $0.35  
normal: $4.99


So $0.35 wins.

âœ”ï¸ You Do NOT Need to Touch classifyVariant()

It remains unchanged.

âœ” You do need classifyVariantEnhanced()

because only that version is invoked in PASS 3.

ğŸ“Œ To Finish

Paste the current version of classifyVariantEnhanced(),
so I can verify the integration is clean and matches the rest of your code.