You've diagnosed this perfectly! This is a **data migration issue**, not a schema or query issue. Your event-sourced model is correct—the problem is that the migration created an invalid transaction. 

## The Fix

You need to **correct the historical purchase transaction** for that Sol Ring. There are two clean approaches:

---

### Option A: Update the Incorrect Transaction (Simplest)

Find the Sol Ring purchase transaction with `quantity = 0` and update it to the **original purchase quantity** (which was `1`, since you sold 1):

```sql
UPDATE transactions 
SET quantity = 1 
WHERE card_name = 'Sol Ring' 
  AND transaction_type = 'PURCHASE' 
  AND quantity = 0;
```

**After this fix:**
- `SUM(quantity) WHERE type = 'PURCHASE'` → **20** ✅
- `SUM(quantity) WHERE type = 'SALE'` → **1**
- Current Inventory = 20 - 1 = **19** ✅

---

### Option B: Delete and Re-insert Correctly (If you want a clean audit trail)

If you prefer not to mutate existing records:

1. Delete the bad transaction
2. Insert the correct one with proper quantity

```sql
-- Remove the invalid 0-quantity purchase
DELETE FROM transactions 
WHERE card_name = 'Sol Ring' 
  AND transaction_type = 'PURCHASE' 
  AND quantity = 0;

-- Insert the correct historical purchase
INSERT INTO transactions (card_name, transaction_type, quantity, date, ...)
VALUES ('Sol Ring', 'PURCHASE', 1, '<original_purchase_date>', ... );
```

---

### Preventing This in Future Migrations

Add a constraint to prevent `quantity = 0` purchases:

```sql
ALTER TABLE transactions
ADD CONSTRAINT positive_purchase_qty 
CHECK (
  transaction_type != 'PURCHASE' OR quantity > 0
);
```

Or in application code:
```python
if transaction_type == 'PURCHASE' and quantity <= 0:
    raise ValueError("Purchase quantity must be positive")
```

---

## Summary

| Metric | Before Fix | After Fix |
|--------|------------|-----------|
| `SUM(PURCHASE)` | 19 ❌ | 20 ✅ |
| `SUM(SALE)` | 1 | 1 |
| Current Inventory | 19 | 19 |
| Equation | Hack (inventory + sales) | Correct (SUM purchases - SUM sales) |

**Recommendation**: Go with **Option A**—it's a simple data correction.  The transaction *should* have been `quantity = 1`, so you're just fixing the migration error.

Would you like help writing a migration script or identifying any other `quantity = 0` purchase records that might exist? 