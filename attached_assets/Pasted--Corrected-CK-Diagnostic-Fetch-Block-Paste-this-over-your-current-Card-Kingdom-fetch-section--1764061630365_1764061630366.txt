‚úÖ Corrected CK Diagnostic Fetch Block

Paste this over your current Card Kingdom fetch section:

// ==================== CARD KINGDOM SCRAPE ====================
let ckPrice = 'N/A';

try {
    console.log(`[CK] Starting fetch for: ${searchName}`);

    const response = await fetchRetry(searchUrl, {
        method: 'GET',
        headers: {
            'User-Agent': USER_AGENT,
            'Accept-Language': 'en-US,en;q=0.9'
        }
    });

    // Diagnostic: Validate the response
    if (!response) {
        console.error(`[CK][FATAL] fetchRetry returned NULL response`);
    } else if (!response.ok) {
        console.error(`[CK][ERROR] Response not OK: status=${response.status}`);
    } else {
        const html = await response.text();

        if (!html || html.length < 50) {
            console.error("[CK][ERROR] Empty or too-short HTML response");
        } else if (html.includes("captcha") || html.includes("verify you are human")) {
            console.error("[CK][ERROR] Card Kingdom page returned CAPTCHA / bot protection");
        } else {
            // SAFE TO PARSE
            const $ = load(html);
            const products = $('div[class*="product"]');

            console.log(`[CK][DEBUG] Found ${products.length} product entries for ${searchName}`);

            if (products.length === 0) {
                console.error("[CK][ERROR] CK returned 0 products‚Äîpossible rate-limit or redirect");
            } else {

                const parsedProducts = [];

                products.each((_, prodEl) => {
                    try {
                        const priceText = $(prodEl).find('.product-card__price').text().trim();
                        const edition = $(prodEl).find('.product-card__set-name').text().trim().toLowerCase();
                        const name = $(prodEl).find('.product-card__name').text().trim().toLowerCase();

                        parsedProducts.push({ name, edition, rawPrice: priceText });
                    } catch (innerErr) {
                        console.error("[CK][ERROR] Failed to parse product block:", innerErr);
                    }
                });

                console.log("[CK][PARSED PRODUCTS]", parsedProducts);

                // Insert your matching + variant ranking logic here
                ckPrice = extractBestCKPrice(parsedProducts, searchName);

                if (ckPrice === 'N/A') {
                    console.error(`[CK][ERROR] Matching logic found NO suitable entries for "${searchName}"`);
                }
            }
        }
    }

} catch (err) {
    console.error("[CK][CRITICAL] Exception during CK fetch:", err);
}

‚≠ê Why This Version Works
‚úî No syntax errors

Every opening { has a matching }.
Every if / else if / else is properly paired.

‚úî Response fully validated

We test:

response === null

response.ok === false

Empty HTML

CAPTCHA pages

Empty product list

Parsing failures

Matching logic failures

‚úî Never early-returns

Your Express route won‚Äôt exit prematurely.

‚úî Provides detailed output when Swamp breaks

You will now clearly see:

[CK][ERROR] CK returned 0 products‚Äîpossible rate-limit

[CK][ERROR] Card Kingdom page returned CAPTCHA

[CK][ERROR] Matching logic found NO suitable entries

[CK][CRITICAL] Exception during CK fetch

[CK][FATAL] fetchRetry returned NULL

üß™ What To Do After Pasting It

Restart server

Query a basic land (Swamp, Plains, Island, etc.)

Send me the complete CK diagnostic logs

Those logs will tell us exactly why Swamp fails intermittently ‚Äî and we fix it permanently.