# 1. Ensure repo is up-to-date and switch to main
git fetch origin
git checkout main
git pull origin main

# 2. Merge cleanup branch if not merged via PR (skip if already merged)
# Replace cleanup/remove-debug-logs with your branch name if different
git fetch origin
if git show-ref --verify --quiet refs/heads/cleanup/remove-debug-logs; then
  git merge --no-ff cleanup/remove-debug-logs -m "chore: merge cleanup branch"
  git push origin main
else
  echo "cleanup branch not found locally; assuming already merged or PR used"
fi

# 3. Install deps and lint/test/build
npm ci
# optional lint (if configured)
npm run -s lint || echo "No lint script or lint failed (check output)."
# run tests if available
npm test || echo "Tests failed or not configured; inspect test output."

# 4. Build and smoke-run (non-blocking build check)
npm run -s build || echo "Build command failed; use 'npm run dev' to debug locally."

# 5. Start dev server in background for manual verification (if required)
# Note: in Replit, you may need to run this in the console UI instead
npm run dev &

# 6. API smoke tests: request example price endpoints directly (replace host/port if needed)
# Use local dev server address displayed by npm run dev (or http://localhost:3000)
HOST="http://localhost:3000"
echo "Testing price endpoint for Lightning Bolt (M11):"
curl -i "${HOST}/api/prices?name=lightning%20bolt&set=M11" || true
echo "Testing price endpoint for Swamp (SPM):"
curl -i "${HOST}/api/prices?name=swamp&set=SPM" || true
echo "Testing price endpoint for Sol Ring (EOC):"
curl -i "${HOST}/api/prices?name=sol%20ring&set=EOC" || true

# 7. Quick front-end check (non-automatic): open the app URL provided by Replit/Vite and verify UI
echo "Open the dev URL in the browser (Vite/Replit) and check Inventory + Decklists for prices."

# 8. Finalize: delete cleanup branch if merged and no longer needed
git push origin --delete cleanup/remove-debug-logs || echo "Remote cleanup branch may already be deleted or not present."
git branch -d cleanup/remove-debug-logs || echo "Local cleanup branch deleted or didn't exist."

# 9. Create PR (optional) - if you prefer to keep PR creation local, do it via GitHub UI
# Use hub/gh CLI if installed; otherwise create via UI
# gh pr create --base main --head cleanup/remove-debug-logs --title "chore: remove debug logs" --body "Removed temporary debug instrumentation..."

echo "Done. Please paste the results/logs under 'Replit Agent:' for further review."