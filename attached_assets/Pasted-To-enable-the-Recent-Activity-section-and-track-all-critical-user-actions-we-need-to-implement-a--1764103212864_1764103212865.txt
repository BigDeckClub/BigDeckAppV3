To enable the "Recent Activity" section and track all critical user actions, we need to implement a **backend solution** to record activity logs and a **frontend integration** to display them in the UI.

---

## ðŸ”§ **Implementation Plan**

### **1. Backend: Add `usage_history` Table**
We need a database table to store activity logs.

#### **`usage_history` Table Schema**
```sql
CREATE TABLE IF NOT EXISTS usage_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    action TEXT NOT NULL,             -- Description of the action
    created_at TEXT NOT NULL,         -- Timestamp of the action
    details TEXT                      -- Additional details (JSON for structured data)
);
```

- **`action`**: A brief description of what was done (e.g., "Added card to inventory").
- **`created_at`**: ISO timestamp of the action.
- **`details`**: JSON-encoded data for context (e.g., card name, quantity, purchase price).

---

### **2. Backend: Add Routes for Usage History**

#### **a. Route to Log an Activity**
- Method: `POST /api/usage-history`
- Purpose: Record a new activity in the `usage_history` table when an action occurs.

```javascript
app.post('/api/usage-history', (req, res) => {
    const { action, details } = req.body;

    // Validate request data
    if (!action || typeof action !== "string") {
        return res.status(400).send({ error: "Action is required and must be a string." });
    }

    const timestamp = new Date().toISOString();
    const detailsJson = details ? JSON.stringify(details) : null;

    // Insert activity into usage_history table
    const query = `
        INSERT INTO usage_history (action, created_at, details)
        VALUES (?, ?, ?)
    `;
    db.run(query, [action, timestamp, detailsJson], function(err) {
        if (err) {
            console.error("[ERROR] Failed to log activity:", err);
            return res.status(500).send({ error: "Failed to log activity." });
        }

        console.log(`[ACTIVITY LOG] Action logged: ${action}`);
        res.status(201).send({ id: this.lastID });
    });
});
```

---

#### **b. Route to Fetch Recent Activities**
- Method: `GET /api/usage-history`
- Purpose: Retrieve recent activity logs, ordered by `created_at` descending.

```javascript
app.get('/api/usage-history', (req, res) => {
    const limit = parseInt(req.query.limit) || 50; // Default to 50 recent activities

    // Fetch activities from the database
    const query = `
        SELECT id, action, created_at, details
        FROM usage_history
        ORDER BY created_at DESC
        LIMIT ?
    `;
    db.all(query, [limit], (err, rows) => {
        if (err) {
            console.error("[ERROR] Failed to fetch activity history:", err);
            return res.status(500).send({ error: "Failed to fetch activity history." });
        }

        console.log(`[ACTIVITY FETCH] Retrieved ${rows.length} activity logs.`);
        res.status(200).send(rows);
    });
});
```

---

### **3. Backend: Update Existing Endpoints to Log Activities**

#### **Log Activities When Actions Happen**

1. **Inventory:**
   Add calls to `recordActivity()` in the `POST`, `PUT`, and `DELETE` endpoints for inventory.

**Example: Add Activity Logging to `POST /api/inventory`**
```javascript
app.post('/api/inventory', (req, res) => {
    const { name, set, quantity, purchase_price, purchase_date } = req.body;

    const query = `
        INSERT INTO inventory (name, set, quantity, purchase_price, purchase_date)
        VALUES (?, ?, ?, ?, ?)
    `;

    db.run(query, [name, set, quantity, purchase_price, purchase_date], function(err) {
        if (err) {
            console.error("[ERROR] Failed to add inventory item:", err);
            return res.status(500).send({ error: "Failed to add inventory item." });
        }

        const newId = this.lastID;
        console.log(`[INVENTORY] Item added: id=${newId}, name=${name}, set=${set}`);

        // Log the activity
        const action = `Added ${quantity}x ${name} (${set}) to inventory.`;
        const details = { name, set, quantity, purchase_price, purchase_date };
        recordActivity(action, details);

        res.status(201).send({ id: newId });
    });
});

function recordActivity(action, details = null) {
    const timestamp = new Date().toISOString();
    const detailsJson = details ? JSON.stringify(details) : null;
    const query = `
        INSERT INTO usage_history (action, created_at, details)
        VALUES (?, ?, ?)
    `;
    db.run(query, [action, timestamp, detailsJson], (err) => {
        if (err) {
            console.error("[ERROR] Failed to record activity:", err);
        } else {
            console.log(`[ACTIVITY LOGGED] ${action}`);
        }
    });
}
```

2. **Container/Decklist/Sales Actions:**
   Add similar logging to **create, edit, delete, and sell operations.**

- **Example: Create Container:**
   ```javascript
   app.post('/api/containers', (req, res) => {
       const { name, decklist_id } = req.body;

       const query = `
           INSERT INTO containers (name, decklist_id)
           VALUES (?, ?)
       `;

       db.run(query, [name, decklist_id], function(err) {
           if (err) {
               console.error("[ERROR] Failed to create container:", err);
               return res.status(500).send({ error: "Failed to create container." });
           }

           const newId = this.lastID;
           console.log(`[CONTAINER] Created container: id=${newId}, name=${name}`);

           // Log the activity
           const action = `Created container: ${name}`;
           const details = { name, decklist_id };
           recordActivity(action, details);

           res.status(201).send({ id: newId });
       });
   });
   ```

---

### **4. Frontend Integration: Fetch and Display History**

#### **`loadUsageHistory` in Frontend**
Fetch usage history from the backend.

```javascript
const loadUsageHistory = async () => {
    try {
        const response = await fetch('/api/usage-history?limit=50');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const history = await response.json();
        console.log("[DEBUG] Fetched usage history:", history);
        setUsageHistory(history);
    } catch (error) {
        console.error("[ERROR] Failed to load usage history:", error);
    }
};
```

#### **`AnalyticsTab.jsx` Render Update**
Render the fetched history dynamically.

```jsx
<div className="card p-6">
    <h2 className="text-xl font-bold mb-4">Recent Activity</h2>
    {usageHistory.length > 0 ? (
        <div className="list-group">
            {usageHistory.map(({ id, action, created_at, details }) => (
                <div key={id} className="list-group-item">
                    <div className="font-semibold">{action}</div>
                    <div className="text-xs text-slate-500">
                        {new Date(created_at).toLocaleString()}
                    </div>
                    {details && (
                        <div className="text-xs text-slate-400">
                            {JSON.stringify(JSON.parse(details), null, 2)}
                        </div>
                    )}
                </div>
            ))}
        </div>
    ) : (
        <p className="text-slate-400">No recent activity recorded.</p>
    )}
</div>
```

---

### **5. Final Testing Checklist**

1. Add and update inventory items:
   - Confirm logs like `"Added 5x Sol Ring (PIP)"` appear in the Recent Activity section.
   
2. Create, edit, and delete containers:
   - Verify creations show as `"Created container: Draft Deck"`.
   - Confirm container deletions are logged.
   
3. Test decklist actions:
   - Import a decklist, make edits, and verify logs.

4. Sell containers:
   - Ensure `"Sold Draft Deck for $150"` appears with sale details.

5. Test error handling:
   - Try invalid actions and confirm no history is recorded until valid.

---

This implementation ensures **comprehensive activity tracking** that keeps users informed about all major actions in the app. Let me know if you need further clarification! ðŸš€