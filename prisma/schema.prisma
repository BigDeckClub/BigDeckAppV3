// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// NEW REFERENCE TABLES (Phase 2)
// ============================================

// Master card catalog - one entry per unique card (by oracle_id)
model Card {
  id             Int        @id @default(autoincrement())
  oracleId       String     @unique @map("oracle_id") @db.VarChar(36)
  name           String     @db.VarChar(255)
  normalizedName String     @map("normalized_name") @db.VarChar(255)
  typeLine       String?    @map("type_line") @db.VarChar(255)
  manaCost       String?    @map("mana_cost") @db.VarChar(100)
  cmc            Decimal?   @db.Decimal(4, 1)
  colors         String[]   @default([])
  colorIdentity  String[]   @map("color_identity") @default([])
  keywords       String[]   @default([])
  oracleText     String?    @map("oracle_text") @db.Text
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  printings Printing[]

  @@index([normalizedName])
  @@index([name])
  @@map("cards")
}

// Set-specific card printings
model Printing {
  id              Int      @id @default(autoincrement())
  cardId          Int      @map("card_id")
  scryfallId      String   @unique @map("scryfall_id") @db.VarChar(36)
  setCode         String   @map("set_code") @db.VarChar(10)
  setName         String   @map("set_name") @db.VarChar(255)
  collectorNumber String?  @map("collector_number") @db.VarChar(20)
  rarity          String?  @db.VarChar(20)
  finish          String?  @db.VarChar(20) // normal, foil, etched
  imageUriSmall   String?  @map("image_uri_small") @db.Text
  imageUriNormal  String?  @map("image_uri_normal") @db.Text
  imageUriLarge   String?  @map("image_uri_large") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  card           Card            @relation(fields: [cardId], references: [id])
  priceSnapshots PriceSnapshot[]
  inventoryItems Inventory[]
  containerItems ContainerItem[]
  deckItems      DeckItem[]

  @@index([cardId])
  @@index([setCode])
  @@index([setCode, collectorNumber])
  @@map("printings")
}

// Price history tracking
model PriceSnapshot {
  id            Int      @id @default(autoincrement())
  printingId    Int      @map("printing_id")
  priceTcg      Decimal? @map("price_tcg") @db.Decimal(10, 2)
  priceCk       Decimal? @map("price_ck") @db.Decimal(10, 2)
  priceScryfall Decimal? @map("price_scryfall") @db.Decimal(10, 2)
  snapshotDate  DateTime @default(now()) @map("snapshot_date")

  printing Printing @relation(fields: [printingId], references: [id])

  @@index([printingId])
  @@index([snapshotDate])
  @@map("price_snapshots")
}

// ============================================
// EXISTING TABLES (with migration fields)
// ============================================

// Inventory table - card stock with purchase history
model Inventory {
  id            Int       @id @default(autoincrement())
  printingId    Int?      @map("printing_id")
  // Legacy fields (keep during migration, remove after verification)
  name          String?   @db.VarChar(255)
  set           String?   @db.VarChar(20)
  setName       String?   @map("set_name") @db.VarChar(255)
  imageUrl      String?   @map("image_url") @db.Text
  scryfallId    String?   @map("scryfall_id") @db.VarChar(255)
  // Core fields
  quantity      Int       @default(1)
  purchasePrice Float?    @map("purchase_price")
  purchaseDate  String?   @map("purchase_date")
  reorderType   String?   @map("reorder_type") @default("Normal") @db.VarChar(20)
  createdAt     DateTime  @default(now()) @map("created_at")

  printing        Printing?         @relation(fields: [printingId], references: [id])
  containerItems  ContainerItem[]
  purchaseHistory PurchaseHistory[]

  @@index([printingId])
  @@index([name])
  @@map("inventory")
}

// Container table - physical card groupings
model Container {
  id         Int       @id @default(autoincrement())
  name       String    @db.VarChar(255)
  decklistId Int?      @map("decklist_id")
  cards      Json?     @default("[]") // Legacy - remove after migration
  createdAt  DateTime  @default(now()) @map("created_at")

  decklist Decklist?       @relation(fields: [decklistId], references: [id], onDelete: SetNull)
  items    ContainerItem[]

  @@map("containers")
}

// Container items - relational storage for container contents
model ContainerItem {
  id          Int  @id @default(autoincrement())
  containerId Int  @map("container_id")
  inventoryId Int? @map("inventory_id")
  printingId  Int? @map("printing_id")
  quantity    Int  @default(1)

  container Container  @relation(fields: [containerId], references: [id], onDelete: Cascade)
  inventory Inventory? @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  printing  Printing?  @relation(fields: [printingId], references: [id])

  @@map("container_items")
}

// Decklist table - deck definitions
model Decklist {
  id        Int       @id @default(autoincrement())
  name      String    @db.VarChar(255)
  decklist  String?   @db.Text // Legacy text format - keep for backward compat
  createdAt DateTime  @default(now()) @map("created_at")

  containers Container[]
  items      DeckItem[]
  sales      Sale[]

  @@map("decklists")
}

// Deck items - parsed decklist cards (new table)
model DeckItem {
  id          Int     @id @default(autoincrement())
  decklistId  Int     @map("decklist_id")
  printingId  Int?    @map("printing_id")
  cardName    String? @map("card_name") @db.VarChar(255) // Fallback if no printing match
  setCode     String? @map("set_code") @db.VarChar(10)
  quantity    Int     @default(1)
  isSideboard Boolean @default(false) @map("is_sideboard")

  decklist Decklist  @relation(fields: [decklistId], references: [id], onDelete: Cascade)
  printing Printing? @relation(fields: [printingId], references: [id])

  @@map("deck_items")
}

// Sales table - completed sales records
model Sale {
  id           Int       @id @default(autoincrement())
  containerId  Int?      @map("container_id")
  decklistId   Int?      @map("decklist_id")
  decklistName String?   @map("decklist_name") @db.VarChar(255)
  salePrice    Decimal?  @map("sale_price") @db.Decimal(10, 2)
  costBasis    Decimal?  @map("cost_basis") @db.Decimal(10, 2)
  soldDate     DateTime  @default(now()) @map("sold_date")
  createdAt    DateTime  @default(now()) @map("created_at")

  decklist Decklist? @relation(fields: [decklistId], references: [id])

  @@map("sales")
}

// Settings table - key-value configuration
model Setting {
  key   String  @id @db.VarChar(255)
  value String? @db.Text

  @@map("settings")
}

// Usage history - activity logging
model UsageHistory {
  id        Int      @id @default(autoincrement())
  action    String   @db.VarChar(255)
  details   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@map("usage_history")
}

// Purchase history - card purchase records
model PurchaseHistory {
  id            Int      @id @default(autoincrement())
  inventoryId   Int      @map("inventory_id")
  purchaseDate  String   @map("purchase_date")
  purchasePrice Float    @map("purchase_price")
  quantity      Int      @default(1)
  createdAt     DateTime @default(now()) @map("created_at")

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Restrict)

  @@map("purchase_history")
}
